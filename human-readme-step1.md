# Этап 1. Очистка и склейка (postprocess v1)

## Зачем
После транскрибации есть `*.txt` и, по возможности, `*.srt / *.jsonl`. Этот шаг:
- чистит речевые «шумы» (приветствия, «слышно/видно», заполнители типа «ну», «эээ») без ущерба тех. терминам;
- снимает подряд идущие дубликаты/почти‑дубликаты коротких реплик;
- склеивает короткие сегменты в связные абзацы, сохраняя таймкоды абзацев (если доступны).

## Результат
В каталоге `transcribe/` для каждого файла появится:
- `*_clean.md` — чистый текст, абзацы разделены пустой строкой;
- `*_packed.jsonl` — по абзацу на строку:
  ```json
  {"type":"paragraph","id":1,"start":123.45,"end":171.02,
   "text":"Абзац...", "segments":[{"start":..., "end":..., "text":"..."}, ...]}
  ```
  Если таймкоды недоступны, поля `start/end` будут опущены, а в отчёте — `"no_timings": true`.
- `*_postprocess_report.json` — метрики и параметры прохода.

## Как запускать
1. Выполните транскрибацию как обычно (получите свежие `*.txt` и, желательно, `*.srt / *.jsonl`).
2. Запустите пост‑обработку:
   ```bash
   python postprocess.py
   ```
   По умолчанию используется каталог `TRANSCRIBE_OUT` из `.env`, иначе `./transcribe`.

## Настройка в `.env`
```env
# Границы и сращивание
POST_MIN_CHARS=48          # минимальная целевая длина абзаца
POST_MERGE_GAP_MS=900      # склейка, если пауза меньше
POST_MAX_PAR_LEN=1200      # «мягкий потолок»; при превышении — умный разрез

# Дедупликация
POST_STRICT_DEDUP=1        # удалять подряд идущие идентичные строки
POST_FUZZY_DEDUP=1         # снимать почти‑дубликаты коротких строк (>=0.9)

# Филлеры
POST_FILLERS_RU="ну,как бы,то есть,ээ,эээ,короче,значит,в общем"
POST_FILLERS_EN="uh,um,like,you know,so,kinda,sort of"

# Вывод
POST_WRITE_CLEAN_TXT=0     # помимо clean.md писать clean.txt
POST_REPORT=1              # сохранять *_postprocess_report.json
```

## Правила (суть)
- Филлеры удаляются **только по краям** реплик/предложений.
- Технические токены (`GPT-2`, `BERT`, `e5-large`, URL/пути/команды) не «ломаются» нормализацией.
- Склейка: пауза ≤ `POST_MERGE_GAP_MS` ИЛИ предыдущая реплика не заканчивается `.?!…` ИЛИ длина предыдущей < `POST_MIN_CHARS`.
- Ограничитель размера абзаца: при длине > `POST_MAX_PAR_LEN` ищем ближайшую «сильную» пунктуацию и режем.

## Критерии приёмки
- Появились `*_clean.md`, `*_packed.jsonl` и (при `POST_REPORT=1`) отчёт.
- Повторы «привет/слышно‑видно» исчезли; текст читается как связная речь.
- При наличии таймкодов абзацы имеют корректные `start/end` (без инверсий и отрицательных значений).
- В отчёте — ненулевые метрики по удалённым дублям и число абзацев.

## Откат
Удалите `postprocess.py` и артефакты `*_clean.*`, `*_packed.jsonl`, `*_postprocess_report.json`.
