# Роадмап проекта: Этапы 1–7

> Предпосылка: «Этап 0. Транскрибация» уже выполняется и создаёт `*.txt` и (желательно) `*.srt / *.jsonl`.

## Этап 1. Очистка и склейка (postprocess v1)
**Цель:** превратить поток сегментов в читабельные абзацы, сохранив таймкоды (если доступны).
**Вход:** `*.jsonl` (предпочтительно) / `*.srt` / `*.txt`.
**Выход:** `*_clean.md`, `*_packed.jsonl`, `*_postprocess_report.json`.
**Ключевые правила:** нормализация; контекстная фильтрация «паразитов»; дедуп подряд/почти‑дубликатов; склейка по gap/длине/пунктуации; ограничитель размера абзаца; защита тех. токенов/URL.
**Критерии приёмки:** появляются артефакты; исчезают приветствия/повторы; корректные таймкоды; отчёт с метриками.

## Этап 2. Главы/Оглавление (chapters v1)
**Цель:** построить главы по крупным паузам/объёму и дать короткие названия.
**Вход:** `*_packed.jsonl`.
**Выход:** `*_chapters.json`, `*_structured.md` (оглавление с таймкодами и текст по главам).
**Метод:** черновые границы — эвристики; затем присвоение названий LLM (локально/через API, по флагу).
**Гарантии качества:** анти‑«микро‑главы», консервативные пороги, слияние малых блоков.

## Этап 2.5. LLM-редактирование транскриптов (edit v1) ⭐ НОВЫЙ
**Цель:** создать структурированный читабельный документ без ошибок транскрибации, освобождённый от «воды» и маркетинга, с сохранением всей смысловой нагрузки и приоритизацией технического контента.
**Вход:** `*_chapters.json`, `*_packed.jsonl`.
**Выход:** `*_edited.md`, `*_edited.jsonl` (улучшенный текст с таймкодами), `*_edit_report.json`.
**Метод:** map-reduce по главам через LLM (Qwen3-32B); промпт для исправления ошибок распознавания, удаления «воды» и маркетинга, сохранения всех технических деталей и идей.
**Особенности:** опциональный этап (флаг `ENABLE_EDIT_STAGE`); фильтр маркетинговых фраз; валидация сохранения технических терминов; контроль длины (не менее 70% от исходной).
**Детали:** см. `STAGE-2.5-SPEC.md`

## Этап 3. Суммаризация и Q&A (summarize v1)
**Цель:** map‑reduce summary по главам → общий tl;dr; обнаружение Q&A (эвристика+LLM).
**Вход:** `*_chapters.json`, `*_packed.jsonl`.
**Выход:** `*_processed.json` (контракт: `title, summary, sections[], qna[], quotes[], action_items[]`), обновлённый `*_structured.md`.
**Контроль фактов:** цитаты с таймкодами, бюджет цитат.

## Этап 4. Индексация и поиск (index v1)
**Цель:** семантический поиск по абзацам/мини‑чанкам.
**Вход:** `*_processed.json`, `*_packed.jsonl`.
**Выход:** индекс FAISS или Chroma + CLI‑поиск.
**Параметры:** эмбеддинги `bge-m3` или `e5-large`; `namespace=video_id` для мульти‑корпуса.

## Этап 5. RAG‑чат (rag v1)
**Цель:** ответы с цитатами и таймкодами.
**Вход:** индекс из Этапа 4.
**Выход:** CLI‑чат (позже — UI).
**Метод:** retrieve top‑k → compose answer; строгий промпт «не выдумывать».

## Этап 6. UI (поиск + плеер + экспорт)
**Цель:** Streamlit или FastAPI+frontend: поиск, предпросмотр, клики на таймкод, экспорт `md/pdf`.
**Особенности:** ссылки на локальный/внешний плеер; копирование цитат/таймкодов.

## Этап 7. Ops/Качество/Тесты
**Цель:** регрессионные тесты, дымовые прогоны, кеширование, флаги `.env`, документация оператора.
**Метрики:** время шага, % удалённых дублей, средняя длина абзаца, доля «без таймкодов».
