# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Production v2 (Enhanced Prompt)

**–î–∞—Ç–∞**: 2025-11-26
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–†–ê–ó–í–Å–†–ù–£–¢–û –í PRODUCTION**

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –≤ production pipeline

**–§–∞–π–ª**: `edit_transcript.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `build_prompt_balanced_v2`** (—Å—Ç—Ä–æ–∫–∏ 122-163)
   - –ü—Ä–æ–º–ø—Ç –≤ —Å—Ç–∏–ª–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –•–∞–±—Ä–∞
   - Fallback-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Dense Technical Content Without Context
   - –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –ø–ª–æ—Ç–Ω–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ

2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `clean_output`** (—Å—Ç—Ä–æ–∫–∏ 166-181)
   - –£–¥–∞–ª—è–µ—Ç `<think>...</think>` —Ç–µ–≥–∏ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ markdown-–æ–±–µ—Ä—Ç–∫–∏ (```markdown...```)
   - Regex –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—ã–≤–æ–¥–∞ –º–æ–¥–µ–ª–∏

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `edit_chapter_with_llm`** (—Å—Ç—Ä–æ–∫–∏ 184-236)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç `build_prompt_balanced_v2`
   - –û–±–Ω–æ–≤–ª–µ–Ω system prompt: "You are a professional technical blog editor. Output clean Markdown only."
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏:
     - `repeat_penalty: 1.1` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
     - `top_k: 40`
     - `num_ctx: 8192`
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `clean_output` –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

4. **–î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–Ω–æ–º–∞–ª–∏–π** (—Å—Ç—Ä–æ–∫–∏ 422-426)
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ < 10% (—ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∞—è)
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ < 15% (–Ω–∏–∑–∫–∞—è, –Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è)

5. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** (—Å—Ç—Ä–æ–∫–∏ 1-17)
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ Production v2
   - –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –£–∫–∞–∑–∞–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è v2

| –ú–µ—Ç—Ä–∏–∫–∞ | v1 (Original) | v2 (Enhanced) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------------|---------------|-----------|
| **–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≥–ª–∞–≤ (<15%)** | 6 (9.2%) | **2 (3.1%)** | **-66%** üî• |
| **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥–ª–∞–≤** | 57 (87.7%) | **63 (96.9%)** | **+10.5%** ‚úÖ |
| **–°—Ä–µ–¥–Ω—è—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è** | 51.83% | **52.65%** | +1.6% |
| **–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å** | 24.96 —Å–µ–∫/–≥–ª–∞–≤–∞ | 26.76 —Å–µ–∫/–≥–ª–∞–≤–∞ | +7% (–ø—Ä–∏–µ–º–ª–µ–º–æ) |

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –≥–ª–∞–≤—ã –î–µ–Ω—å 3 (PyTorch –ª–µ–∫—Ü–∏–∏)**:
- –ì–ª–∞–≤–∞ 9: 9.35% ‚Üí **31.34%** (+235%)
- –ì–ª–∞–≤–∞ 10: 9.52% ‚Üí **14.22%** (+49%)
- –ì–ª–∞–≤–∞ 11: 7.81% ‚Üí **12.42%** (+59%)
- –ì–ª–∞–≤–∞ 12: 6.99% ‚Üí **20.33%** (+191%)

**–î–µ–Ω—å 1, –ì–ª–∞–≤–∞ 7** (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è + Q&A):
- 0.70% ‚Üí **14.26%** (+1937%!)

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Production

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```bash
EDIT_LLM_MODEL="qwen3:32b"
EDIT_LLM_TEMPERATURE=0.3
EDIT_LLM_MAX_TOKENS=3000
EDIT_MIN_LENGTH_RATIO=0.7  # –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–Ω–∏–∂–µ–Ω –¥–æ 0.5 –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≥–ª–∞–≤
EDIT_MAX_LENGTH_RATIO=1.3
EDIT_REPORT=true
EDIT_DRY_RUN=false
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ (–≤ –∫–æ–¥–µ)

```python
options={
    "temperature": 0.3,        # –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∞–º–∏ –∏ —Å—Ç–∏–ª–µ–º
    "repeat_penalty": 1.1,     # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
    "top_k": 40,               # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π sampling
    "num_ctx": 8192,           # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ
    "num_predict": 3000        # –ú–∞–∫—Å–∏–º—É–º –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
}
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ production pipeline

```bash
# –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ .env)
python edit_transcript.py

# –ò–ª–∏ —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
EDIT_LLM_MODEL="qwen3:32b" \
EDIT_MIN_LENGTH_RATIO=0.5 \
python edit_transcript.py
```

### –í—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã

Pipeline –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `transcribe/`:
- `*_chapters.json` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–ª–∞–≤
- `*_packed.jsonl` - –∞–±–∑–∞—Ü—ã —Å —Ç–∞–π–º–∏–Ω–≥–∞–º–∏

### –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞—é—Ç—Å—è:
- `*_edited.md` - —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –≤ Markdown (Habr-style)
- `*_edit_report.json` - –æ—Ç—á—ë—Ç –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

Pipeline —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç:

1. **–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è (<10%)**:
   ```
   ‚ö†Ô∏è –ì–ª–∞–≤–∞ X: —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è (8.51%). –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.
   ```

2. **–ù–∏–∑–∫–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è (<15%)**:
   ```
   ‚ÑπÔ∏è –ì–ª–∞–≤–∞ X: –Ω–∏–∑–∫–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è (14.26%), –Ω–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ.
   ```

3. **–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**:
   - –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º —Å–æ–∫—Ä–∞—Ç–∏–ª—Å—è (< min_length_ratio)
   - –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º —É–≤–µ–ª–∏—á–∏–ª—Å—è (> max_length_ratio)
   - –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ê–Ω–∞–ª–∏–∑ –æ—Ç—á—ë—Ç–∞

–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `*_edit_report.json`:
```json
{
  "total_chapters": 65,
  "failed_validations": 0,
  "overall_compression_ratio": 0.5265,
  "chapters_summary": [
    {
      "id": 8,
      "title": "...",
      "compression_ratio": 0.0851  // ‚ö†Ô∏è Edge case
    }
  ]
}
```

---

## üîß –ò–∑–≤–µ—Å—Ç–Ω—ã–µ Edge Cases

### 1. –î–µ–Ω—å 3, –ì–ª–∞–≤–∞ 8 (8.51% –∫–æ–º–ø—Ä–µ—Å—Å–∏—è)

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–µ—Ä–≤–∞—è –≤ —Å–µ—Ä–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≥–ª–∞–≤ PyTorch
**–ü—Ä–∏—á–∏–Ω–∞**: –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
**–†–µ—à–µ–Ω–∏–µ**: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (1 –≥–ª–∞–≤–∞ –∏–∑ 65 = 1.5% –∞–Ω–æ–º–∞–ª–∏–π - –ø—Ä–∏–µ–º–ª–µ–º–æ)

**–û–ø—Ü–∏–∏**:
- ‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
- –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- –°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è "–ø–µ—Ä–≤—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≥–ª–∞–≤ –≤ —Å–µ—Ä–∏–∏"

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `build_prompt_balanced_v2` –≤ production pipeline
- [x] –î–æ–±–∞–≤–∏—Ç—å `clean_output` –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É
- [x] –û–±–Ω–æ–≤–∏—Ç—å system prompt
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ (repeat_penalty, top_k, num_ctx)
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
- [x] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Qwen3:32b –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ GPU VRAM
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ: q5_k_m –∏–ª–∏ q8_0 (–Ω–µ q4)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ < 10% (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `PRODUCTION_FINAL_REPORT.md` - –ü–æ–ª–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º
- `test_production_full_v2.py` - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç v2 (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å)
- `production_output_v2/` - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ 65 –≥–ª–∞–≤–∞—Ö
- `optimal-feedback-v3.md` - Feedback –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã

---

## üéì –í—ã–≤–æ–¥—ã

1. ‚úÖ Production v2 —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ pipeline
2. ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –ø–ª–æ—Ç–Ω–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ä–µ—à–µ–Ω–∞ –Ω–∞ 80%
3. ‚úÖ –ê–Ω–æ–º–∞–ª–∏–∏ —Å–Ω–∏–∂–µ–Ω—ã —Å 9.2% –¥–æ 3.1%
4. ‚úÖ 96.9% –≥–ª–∞–≤ —Å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
5. ‚úÖ Pipeline –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤

---

**–î–∞—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è**: 2025-11-26
**–í–µ—Ä—Å–∏—è**: Production Final v2 (Enhanced Prompt)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **DEPLOYED AND READY**

üöÄ **Production v2 is live!**
